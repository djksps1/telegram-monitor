# Telegram 消息监控程序

[English](./README_EN.md)

## 项目简介

本项目是一个基于 Python 的 Telegram 消息监控程序，利用 [Telethon](https://github.com/LonamiWebs/Telethon) 库与 Telegram API 进行交互。  
在最新版本中，程序在原有功能基础上新增并改进了以下主要特性：

- **消息监控**  
  程序可监听指定对话中的消息，支持关键词匹配、正则表达式匹配以及文件后缀名匹配。  
  当匹配成功时，程序可以自动转发消息、发送邮件通知或将匹配结果记录到本地文件。  
  此外，新增了**回复功能**：  
  当检测到设定关键词时，可根据用户配置的回复词组，从中随机选择一条作为回复内容，在同一对话中直接回复该消息。  
  用户还可设置回复前的随机延时（在指定的时间范围内），使回复更自然。

- **全量监控与用户过滤**  
  对指定频道、群组或对话进行全量监控，并支持基于用户 ID、用户名或昵称进行过滤，  
  仅处理符合条件的消息，避免无关日志输出。  
  此外，还支持将匹配的消息保存到本地文件。

- **定时消息**  
  通过 Cron 表达式配置定时消息任务，支持设置随机延时以及发送后自动删除消息。  
  同时，新增了定时开关机功能，可以指定时间开关机，支持 Cron 表达式。

- **按钮与图片处理**  
  针对带有 Inline 按钮和图片的消息，程序会自动调用 AI 模型识别图片内容，  
  并根据 AI 的反馈自动选择并点击对应按钮。  
  若 AI 模型调用失败，程序会重试（最多一次），若仍失败则放弃处理并删除本地图片。

- **账号管理（数字序号管理）**  
  账号管理现已优化：  
  - 系统按账号添加顺序为每个账号分配一个数字序号（从 1 开始，添加顺序越早序号越小）。  
  - 在显示账号列表时，将同时展示账号的序号与手机号；  
  - 切换账号时，用户只需输入对应的序号即可完成切换，操作更简便直观。

- **配置管理**  
  - **一键导出所有账号配置**：将所有已登录账号的配置信息（包括关键词、文件后缀、全量监控、按钮监控、图片监听和定时任务配置）导出到一个 JSON 文件，文件中以账号标识（手机号）作为 key。  
  - **选择性导入配置**：支持根据导出文件中保存的账号标识，为当前已登录的账号导入配置，且新增的回复功能配置项（回复开关、回复词组、回复延时范围）也会被导入，不足项自动补充默认值。

- **代理支持**  
  支持用户配置代理（socks5、socks4 或 HTTP），方便在受限网络环境下连接 Telegram。

- **日志记录**  
  程序通过日志文件记录关键事件、错误信息及匹配处理过程。  
  改进后的日志输出仅记录实际匹配并处理的事件，避免产生冗余日志，使日志内容更加清晰。

## 功能特性

- **关键词监控**  
  - 支持完全匹配、关键词匹配和正则表达式匹配。  
  - 可选配置自动转发、邮件通知、日志记录；  
  - 对于正则匹配，可配置将匹配结果转发到指定对话（支持随机延时与发送后删除）；  
  - **新增回复功能**：当检测到关键词时，可在同一对话中回复消息，回复内容从预先配置的多个词组中随机选择，并可设置回复前的随机延时。

- **文件后缀名监控**  
  针对特定文件后缀（如 `.pdf`、`.docx` 等）的消息自动进行处理，支持自动转发与邮件通知。  
  同时新增了用户过滤功能，允许基于用户 ID、用户名或昵称过滤消息。

- **全量监控与用户过滤**  
  可对指定频道、群组或对话进行全量消息监控，  
  同时支持仅处理特定用户（通过用户 ID、用户名或昵称）的消息，避免无关日志输出。  
  支持将匹配的消息记录保存到本地。

- **定时消息**  
  利用 Cron 表达式配置定时发送的消息，  
  支持设置随机延时以及发送后自动删除。  
  新增了定时开关机功能，支持指定时间开关机，并支持 Cron 表达式设置。

- **按钮与图片处理**  
  当消息中包含图片和 Inline 按钮时，自动调用 AI 模型识别图片内容，  
  根据 AI 的反馈自动点击对应按钮；  
  若调用 AI 模型失败，则重试一次，若多次失败则放弃处理并删除本地图片。

- **账号管理**  
  - 账号以添加顺序进行编号（从 1 开始），在命令交互中显示数字序号及对应手机号；  
  - 切换账号时，用户可直接通过输入数字序号来切换。

- **配置管理**  
  - **导出配置**：将所有账号的监控配置（包含新增的回复功能字段）完整导出为 JSON 文件；  
  - **导入配置**：支持选择性导入配置，并对缺失的回复功能字段自动补充默认值。

- **代理支持**  
  支持 socks5、socks4 和 HTTP 代理，方便在不同网络环境下运行。

- **新增运行指定次数**
所有监控配置新增可指定运行次数功能，运行指定次数后程序会自动将配置删除

## 环境要求

- Python 3.7 及以上版本  
- 依赖库：Telethon、openai、pytz、apscheduler、PySocks、smtplib 等  
- 需获取 Telegram 的 `api_id` 与 `api_hash`  
- 配置 SMTP 邮箱信息（如需邮件通知）  
- 配置 One/NEW API 的 `api_key` 与 `api_base_url` 以调用 AI 模型服务（如需图片识别）

## 安装指南

1. 克隆或下载本项目代码：
   ```bash
   git clone https://github.com/djksps1/telegram-monitor.git

 
2. 安装依赖：
   ```bash
   pip install -r requirements.txt


3. 获取 Telegram API 凭证（`api_id` 和 `api_hash`）。
 
4. 配置 One/NEW API 的 `api_key` 与 `api_base_url` 以使用 AI 模型服务。
 
5. 配置 SMTP 邮箱信息（如需邮件通知）。

## 使用说明 
 
1. **运行程序** 
启动程序：

```bash
python monitor.py
```
 
1. **登录 Telegram** 
程序首次运行时会提示输入 `api_id`、`api_hash`、手机号及验证码（如启用两步验证，还需输入密码）。
 
2. **配置监控参数** 
程序启动后进入交互式命令模式，用户可根据需求添加或修改各类监控配置（包括关键词监控、文件后缀监控、全量监控、按钮监控、定时任务、图片监听）。
注意：在关键词配置中，您可以启用回复功能，配置回复词组以及回复延时范围，程序将在检测到关键词时自动在原消息所在对话中回复一条随机回复内容。
 
3. **配置管理**
 
- 使用 `exportallconfig` 命令可以一键导出所有账号配置，生成的 JSON 文件中包含完整的监控参数（包括新增的回复功能配置）。
 
- 使用 `importallconfig` 命令时，程序将读取配置文件中的账号标识（手机号），并自动补充缺失的回复功能字段（如 `reply_enabled`、`reply_texts`、`reply_delay_min`、`reply_delay_max`）到当前配置中。
 
1. **账号管理**
 
- 在 `listaccount` 命令中，将显示所有已登录账号的数字序号及对应手机号；
 
- 切换账号时，请输入显示的数字序号（例如输入 `1` 切换到第一个添加的账号）。
 
1. **启动监控** 
完成配置后，输入 `start` 命令开始监控消息。

## 可用命令列表 
 
- **账号管理**  
  - `addaccount`：添加新账号
 
  - `removeaccount`：移除账号
 
  - `listaccount`：列出所有账号（以数字序号显示）
 
  - `switchaccount`：通过输入数字序号切换当前工作账号
 
- **配置管理**  
  - `exportallconfig`：一键导出所有账号配置
 
  - `importallconfig`：选择性导入配置（支持自动补全新增字段）
 
  - `blockbot` / `unblockbot`：屏蔽或取消屏蔽指定 Telegram Bot
 
- **监控配置管理**  
  - `addkeyword` / `modifykeyword` / `removekeyword` / `showkeywords`：管理关键词监控
（注：在添加或修改关键词配置时，支持设置自动转发、邮件通知、日志记录以及回复功能）
 
  - `addext` / `modifyext` / `removeext` / `showext`：管理文件后缀监控（支持用户过滤功能）
 
  - `addall` / `modifyall` / `removeall` / `showall`：管理全量监控配置（支持消息记录保存到本地）
 
  - `addbutton` / `modifybutton` / `removebutton` / `showbuttons`：管理按钮关键词监控
 
  - `addimagelistener` / `removeimagelistener` / `showimagelistener`：管理图片+按钮监听对话ID
 
- **定时任务管理**  
  - `schedule` / `modifyschedule` / `removeschedule` / `showschedule`：管理定时消息任务（支持随机延时及自动删除）
 
- **监控控制**  
  - `start` / `stop`：启动或停止监控
 
  - `exit`：退出程序

## 功能细节 
 
- **关键词监控** 
支持多种匹配模式（完全匹配、部分匹配、正则匹配），同时可配置自动转发、邮件通知和日志记录。
**新增回复功能**  ：在匹配到设定关键词后，程序将根据配置的延时设置等待一段随机时间，再从回复词组中随机选择一条回复到原消息所在对话中。
 
- **文件后缀名监控** 
针对特定文件类型的消息进行自动处理，支持自动转发和邮件通知，同时新增了用户过滤功能。
 
- **全量监控与用户过滤** 
可针对指定频道、群组或对话进行全量监控，并根据用户过滤条件只处理符合要求的消息。支持将匹配的消息记录保存到本地。
 
- **按钮与图片处理** 
自动调用 AI 模型识别图片内容，并根据 AI 的反馈自动点击对应按钮；支持失败重试及本地图片清理。
 
- **定时消息** 
使用 Cron 表达式设置定时任务，支持随机延时及发送后自动删除消息。新增了定时开关机功能，支持设置指定时间开关机。
 
- **账号管理** 
账号按添加顺序进行编号显示，方便通过数字序号进行查看和切换。
 
- **配置管理** 
导出和导入功能支持完整保存所有监控配置，包括新增的回复功能参数，确保跨机器使用及备份恢复时配置完整。
 
- **代理支持** 
用户可选择配置代理，使程序在网络受限环境下正常运行。
 
- **日志记录** 
日志文件 `telegram_monitor.log` 记录程序运行状态、错误信息和实际匹配处理事件，确保日志简洁有效。

## 注意事项 
 
- 请遵守 Telegram 使用条款，避免滥用监控功能导致账号受限。
 
- 妥善保管您的 `api_id`、`api_hash` 及会话文件，防止账号信息泄露。
 
- 如需邮件通知，请正确配置 SMTP 信息及授权码。
 
- 配置 One/NEW API 的 `api_key` 与 `api_base_url` 以使用 AI 模型服务进行图片识别。
  
- 屏蔽或监测群聊中指定频道或机器人时，频道id输入格式为去除前面的"-100",如频道id为:-1001234567,则输入:1234567,机器人则输入bot_id，监控频道时则正常输入频道id

## 常见问题 
 
1. **无法连接 Telegram** 
检查网络、代理配置及 API 凭证是否正确。
 
2. **邮件发送失败** 
请确认 SMTP 配置正确，并设置了正确的邮箱授权码。
 
3. **AI 模型调用失败** 
程序会自动重试一次，若仍失败则放弃本次处理并删除本地图片。
 
4. **定时任务不执行** 
检查 Cron 表达式、时区设置，并确认调度器已启动。

## 贡献与支持 

欢迎大家提出建议和改进意见。如有问题或希望新增功能，请提交 Issue 或 Pull Request。

## 许可证 

本项目采用 MIT 许可证。
