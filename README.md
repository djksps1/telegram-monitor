# Telegram 消息监控程序

[English](./README_EN.md)

## 项目简介

本项目是一个基于 Python 的 Telegram 消息监控程序，利用 [Telethon](https://github.com/LonamiWebs/Telethon) 库与 Telegram API 进行交互。  
在最新版本中，程序新增并改进了以下主要特性：

- **消息监控**  
  监听指定对话中的消息，支持关键词匹配、正则表达式匹配和文件后缀名匹配。  
  当匹配成功时，可自动转发消息、发送邮件通知或将匹配结果记录到本地文件。  
  （非匹配的消息将不再产生冗余日志记录，日志只保留实际匹配的处理信息。）

- **全量监控与用户过滤**  
  对指定频道、群组或对话进行全量监控，同时支持基于用户ID、用户名或昵称进行过滤，  
  仅处理符合条件的消息，避免无关日志输出。

- **定时消息**  
  通过 Cron 表达式添加定时消息任务，支持配置随机延时以及发送后自动删除。

- **按钮与图片处理**  
  针对带有 Inline 按钮和图片的消息，程序会自动将图片上传到 AI 模型进行识别，  
  根据 AI 的回答自动选择并点击对应按钮。  
  若第一次调用 AI 模型失败，程序会在10秒后重试一次，若仍失败则放弃处理并删除本地图片。

- **配置管理**  
  - **一键导出所有账号配置**：将当前登录的所有账号的配置信息（包括关键词、文件后缀、全量监控、按钮监控、图片监听和定时任务配置）导出到一个 JSON 文件，文件中会以账号标识（即手机号）作为 key。  
  - **选择性导入配置**：在导入时程序会读取配置文件中保存的账号标识，用户可以选择性地为当前已登录的账号导入配置，从而实现跨机器或备份恢复的功能。

- **代理支持**  
  支持用户配置代理 IP，使得程序能够在受限网络环境下顺利连接 Telegram。

- **日志记录**  
  程序通过日志文件记录关键事件、错误信息及匹配处理过程。  
  与之前版本相比，优化了日志输出逻辑：  
  对于不匹配用户过滤条件的消息（包括文本、文件和全量监控），将不再输出冗余日志，  
  使日志内容更加清晰，仅保留真正匹配并处理的事件记录。

## 功能特性

- **关键词监控**  
  - 支持完全匹配、关键词匹配和正则表达式匹配。  
  - 可选配置自动转发、邮件通知、记录到本地文件；对于正则匹配，可配置将匹配结果转发到指定对话，支持随机延时和发送后删除。

- **文件后缀名监控**  
  - 针对特定文件后缀（如 `.pdf`、`.docx` 等）的消息自动进行处理，支持自动转发与邮件通知。

- **全量监控与用户过滤**  
  - 可对指定频道、群组或对话进行全量消息监控，  
  - 同时支持只处理特定用户（通过用户ID、用户名或昵称）的消息，避免无关日志输出。

- **定时消息**  
  - 使用 Cron 表达式配置定时发送的消息，  
  - 可设置随机延时以及发送后自动删除功能。

- **按钮与图片处理**  
  - 当消息中包含图片和 Inline 按钮时，自动调用 AI 模型识别图片内容，  
  - 根据 AI 回答自动点击相应按钮。  
  - 若 AI 调用失败，程序会自动重试，并在多次失败后放弃处理且删除本地图片。

- **配置管理**  
  - **一键导出所有账号配置**：将所有账号（以手机号为账号标识）的监控配置导出到单一 JSON 文件。  
  - **选择性导入配置**：通过读取配置文件中的账号标识，实现对部分账号配置的恢复更新。

- **代理支持**  
  用户可选择配置代理（socks5、socks4 或 HTTP），便于在网络受限环境下正常运行。

## 环境要求

- Python 3.7 及以上版本  
- 依赖库：Telethon、openai、pytz、apscheduler、PySocks、smtplib 等  
- 需要 Telegram 的 `api_id` 与 `api_hash`  
- 配置 SMTP 邮箱信息（如需邮件通知）  
- 配置 One/NEW API 的 `api_key` 与 `base_url` 用于调用 AI 模型（如需图片识别）

## 安装指南

1. 克隆或下载本项目代码：
   ```bash
   git clone https://github.com/djksps1/telegram-monitor.git
```
 
1. 安装依赖：

```bash
pip install -r requirements.txt
```
 
2. 获取 Telegram API 凭证（`api_id` 和 `api_hash`）。
 
3. 配置 One/NEW API 的 `api_key` 与 `api_base_url` 以使用 AI 模型服务。

4. 配置 SMTP 邮箱信息（如需邮件通知）。

## 使用说明 
 
1. **运行程序** 
启动程序：

```bash
python monitor.py
```
 
2. **登录 Telegram** 
程序首次运行时需要输入 `api_id`、`api_hash`，并根据提示输入您的 Telegram 手机号和收到的验证码（如启用两步验证，还需输入密码）。
 
3. **配置监控参数** 
程序启动后，会显示交互式命令列表，用户可根据需求添加、修改各类监控配置（关键词、文件后缀、全量监控、按钮监控、定时任务、图片监听）。
 
4. **配置管理**  
  - 使用 `exportallconfig` 命令（一键导出所有账号配置）：
导出的 JSON 文件中，账号标识为手机号，便于后续统一备份和迁移。
 
  - 使用 `importallconfig` 命令（选择性导入配置）：
程序将读取配置文件中的账号标识，您可选择性为当前已登录的账号导入配置。
 
5. **启动监控** 
完成配置后，输入 `start` 命令开始监控。

## 可用命令列表 
 
- **账号管理**  
  - `addaccount`：添加新账号
 
  - `removeaccount`：移除账号
 
  - `listaccount`：列出所有账号
 
  - `switchaccount`：切换当前工作账号
 
- **配置管理**  
  - `exportallconfig`：一键导出所有账号配置
 
  - `importallconfig`：根据配置文件中账号标识选择性导入配置
 
  - `blockbot` / `unblockbot`：屏蔽或取消屏蔽指定 TG Bot
 
- **监控配置管理**  
  - `addkeyword` / `modifykeyword` / `removekeyword` / `showkeywords`：管理关键词监控
 
  - `addext` / `modifyext` / `removeext` / `showext`：管理文件后缀监控
 
  - `addall` / `modifyall` / `removeall` / `showall`：管理全量监控配置
 
  - `addbutton` / `modifybutton` / `removebutton` / `showbuttons`：管理按钮关键词监控
 
  - `addimagelistener` / `removeimagelistener` / `showimagelistener`：管理针对图片+按钮消息的监听对话ID
 
- **定时任务管理**  
  - `schedule` / `modifyschedule` / `removeschedule` / `showschedule`：管理定时消息任务
 
- **监控控制**  
  - `start` / `stop`：启动或停止监控
 
  - `exit`：退出程序

## 功能细节 
 
- **关键词监控** 
可配置完全匹配、部分匹配或正则匹配，支持自动转发、邮件通知、日志记录以及对正则匹配结果的特殊处理（延时转发与发送后删除）。
 
- **文件后缀名监控** 
针对指定文件类型消息进行处理，支持自动转发与邮件通知。
 
- **全量监控与用户过滤** 
可对指定频道或群组进行全量消息监控，并根据用户过滤条件（用户ID、用户名或昵称）只处理匹配的消息，从而避免无关日志记录。
 
- **按钮与图片处理** 
自动识别图片中的内容并根据 AI 模型反馈自动点击 Inline 按钮；支持失败重试及本地图片清理。
 
- **定时消息** 
使用 Cron 表达式设置定时任务，支持随机延时和发送后自动删除。
 
- **日志记录** 
日志文件 `telegram_monitor.log` 用于记录程序运行状态和错误信息。
改进后的日志输出仅记录匹配并处理的事件，非匹配情况不再写入日志，确保日志简洁有效。

## 注意事项 

- 请遵守 Telegram 使用条款，避免滥用监控功能导致账号受限。
 
- 妥善保管您的 `api_id`、`api_hash` 及登录会话文件，防止账号信息泄露。

- 如需邮件通知，请正确配置 SMTP 信息和授权码。
 
- 配置 One/NEW API 的 `api_key` 与 `api_base_url` 以使用 AI 模型服务。

## 常见问题 
 
1. **无法连接 Telegram** 
检查网络、代理配置以及 API 凭证是否正确。
 
2. **邮件发送失败** 
请确保 SMTP 配置正确，并已设置正确的邮箱授权码。
 
3. **AI 模型调用失败** 
程序会自动重试一次，若仍失败则放弃本次处理并删除本地图片。
 
4. **定时任务不执行** 
检查 Cron 表达式、时区配置，并确认调度器已启动。

## 贡献与支持 

欢迎提出建议和改进。如有问题或希望新增功能，请提交 Issue 或 Pull Request。

## 许可证 

本项目采用 MIT 许可证。

